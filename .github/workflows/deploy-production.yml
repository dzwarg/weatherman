# GitHub Actions Workflow: Production Deployment (Blue-Green)
#
# Purpose: Deploy to production using blue-green pattern with zero downtime
# Trigger: Push to main branch (after PR merge)
# Runner: Self-hosted (production server)
# Strategy: Blue-Green deployment with automatic rollback on failure
#
# Phase 5: Post-Merge Deployment (T032-T044)

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - '.specify/**'
      - 'specs/**'

# T033: Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false  # Let current deployment finish

env:
  NODE_VERSION: '22'
  DEPLOYMENT_STATE_DIR: '/var/lib/weatherman/state'

jobs:
  # T034: Determine which environment is currently active
  detect-environment:
    name: Detect Active Environment
    runs-on: [self-hosted]
    timeout-minutes: 5
    outputs:
      active_env: ${{ steps.detect.outputs.active }}
      inactive_env: ${{ steps.detect.outputs.inactive }}
      active_port: ${{ steps.detect.outputs.active_port }}
      inactive_port: ${{ steps.detect.outputs.inactive_port }}
    steps:
      - name: Detect active environment from nginx config
        id: detect
        run: |
          # Check nginx upstream configuration to determine active environment
          NGINX_CONF="/etc/nginx/sites-enabled/weatherman"

          if ! [ -f "$NGINX_CONF" ]; then
            echo "‚ö†Ô∏è  Nginx config not found, defaulting to Blue as active"
            echo "active=blue" >> $GITHUB_OUTPUT
            echo "inactive=green" >> $GITHUB_OUTPUT
            echo "active_port=3001" >> $GITHUB_OUTPUT
            echo "inactive_port=3002" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract current upstream port from nginx config
          ACTIVE_PORT=$(grep -oP 'proxy_pass\s+http://localhost:\K\d+' "$NGINX_CONF" | head -1)

          if [ "$ACTIVE_PORT" == "3001" ]; then
            echo "üîµ Blue environment is active (port 3001)"
            echo "active=blue" >> $GITHUB_OUTPUT
            echo "inactive=green" >> $GITHUB_OUTPUT
            echo "active_port=3001" >> $GITHUB_OUTPUT
            echo "inactive_port=3002" >> $GITHUB_OUTPUT
          elif [ "$ACTIVE_PORT" == "3002" ]; then
            echo "üü¢ Green environment is active (port 3002)"
            echo "active=green" >> $GITHUB_OUTPUT
            echo "inactive=blue" >> $GITHUB_OUTPUT
            echo "active_port=3002" >> $GITHUB_OUTPUT
            echo "inactive_port=3001" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Could not determine active environment, defaulting to Blue"
            echo "active=blue" >> $GITHUB_OUTPUT
            echo "inactive=green" >> $GITHUB_OUTPUT
            echo "active_port=3001" >> $GITHUB_OUTPUT
            echo "inactive_port=3002" >> $GITHUB_OUTPUT
          fi

  # T035: Deploy to the inactive environment
  deploy-inactive:
    name: Deploy to Inactive Environment
    runs-on: [self-hosted]
    timeout-minutes: 10
    needs: [detect-environment]
    environment:
      name: production
      url: https://weatherman.zwarg.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build --workspace=packages/frontend

      - name: Check deployment prerequisites
        run: |
          echo "üîç Deployment Prerequisites Check"
          echo "=================================="
          echo "Current user: $(whoami)"
          echo "Current UID: $(id -u)"
          echo "Current groups: $(groups)"
          echo ""
          echo "Checking sudoers configuration..."
          if sudo -n true 2>/dev/null; then
            echo "‚úÖ Sudo access configured (NOPASSWD working)"
          else
            echo "‚ùå Sudo requires password - sudoers not configured correctly"
            echo ""
            echo "To fix this issue:"
            echo "1. Install sudoers file for user: $(whoami)"
            echo "   sudo ./scripts/deployment/install-sudoers.sh $(whoami)"
            echo ""
            echo "2. Verify installation:"
            echo "   sudo -l -U $(whoami)"
            exit 1
          fi

      - name: Stop inactive environment
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          echo "Stopping $INACTIVE_ENV environment..."

          # Stop PM2 processes for inactive environment
          npx pm2 stop "weatherman-$INACTIVE_ENV" || echo "Process not running"
          npx pm2 delete "weatherman-$INACTIVE_ENV" || echo "Process not found"

      - name: Deploy to inactive environment
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          WEATHER_API_URL: ${{ secrets.WEATHER_API_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL }}
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"

          echo "Deploying to $INACTIVE_ENV environment (port $INACTIVE_PORT)..."

          # Use deployment script
          bash scripts/deployment/deploy-to-$INACTIVE_ENV.sh

      # T039: Health check polling
      - name: Wait for health check
        run: |
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"
          HEALTH_URL="http://localhost:$INACTIVE_PORT/api/health"
          MAX_ATTEMPTS=24  # 2 minutes (5 second intervals)
          ATTEMPT=0

          echo "Waiting for $HEALTH_URL to respond..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      # T043: Update deployment state
      - name: Update deployment state
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          STATE_FILE="${{ env.DEPLOYMENT_STATE_DIR }}/$INACTIVE_ENV.json"

          # Ensure state directory exists
          sudo mkdir -p "${{ env.DEPLOYMENT_STATE_DIR }}"

          # Write state file using sudo tee (required for /var/lib/ access)
          cat <<EOF | sudo tee "$STATE_FILE" > /dev/null
          {
            "environment": "$INACTIVE_ENV",
            "status": "deployed",
            "port": ${{ needs.detect-environment.outputs.inactive_port }},
            "commit_sha": "${{ github.sha }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF

          # Set readable permissions on state file
          sudo chmod 644 "$STATE_FILE"

          echo "‚úÖ Updated state for $INACTIVE_ENV environment"

  # T049-T050: Post-deployment validation tests
  post-deployment-tests:
    name: Post-Deployment Validation
    runs-on: [self-hosted]
    timeout-minutes: 15  # T050: 15-minute timeout for post-deployment tests
    needs: [detect-environment, deploy-inactive]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run post-deployment test suite
        env:
          BASE_URL: http://localhost:${{ needs.detect-environment.outputs.inactive_port }}
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"
          ACTIVE_ENV="${{ needs.detect-environment.outputs.active_env }}"
          ACTIVE_PORT="${{ needs.detect-environment.outputs.active_port }}"

          echo "Running post-deployment tests on $INACTIVE_ENV environment..."
          bash scripts/testing/run-post-deployment-tests.sh \
            "$INACTIVE_ENV" \
            "$INACTIVE_PORT" \
            "$ACTIVE_ENV" \
            "$ACTIVE_PORT"

  # T053-T055: Traffic switching with state updates
  switch-traffic:
    name: Switch Traffic
    runs-on: [self-hosted]
    timeout-minutes: 5
    needs: [detect-environment, post-deployment-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Switch traffic to inactive environment
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"

          echo "Switching traffic to $INACTIVE_ENV environment..."
          sudo bash scripts/deployment/switch-traffic.sh "$INACTIVE_ENV"

      # T054: Nginx reload with verification
      - name: Verify nginx configuration and reload
        run: |
          echo "Verifying nginx configuration..."

          # Test nginx config syntax
          sudo nginx -t

          # Reload nginx to apply new upstream
          echo "Reloading nginx..."
          sudo systemctl reload nginx

          # Verify nginx is still running
          if sudo systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx reloaded successfully"
          else
            echo "‚ùå Nginx failed to reload"
            exit 1
          fi

      # T055: Update deployment state files to mark environments active/inactive
      - name: Update deployment state after traffic switch
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          ACTIVE_ENV="${{ needs.detect-environment.outputs.active_env }}"
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"
          ACTIVE_PORT="${{ needs.detect-environment.outputs.active_port }}"

          STATE_DIR="${{ env.DEPLOYMENT_STATE_DIR }}"

          # Update new active environment state (was inactive, now active)
          cat <<EOF | sudo tee "$STATE_DIR/$INACTIVE_ENV.json" > /dev/null
          {
            "environment": "$INACTIVE_ENV",
            "status": "active",
            "traffic_routing": "active",
            "port": $INACTIVE_PORT,
            "commit_sha": "${{ github.sha }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}",
            "switched_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Update old active environment state (was active, now inactive)
          cat <<EOF | sudo tee "$STATE_DIR/$ACTIVE_ENV.json" > /dev/null
          {
            "environment": "$ACTIVE_ENV",
            "status": "inactive",
            "traffic_routing": "inactive",
            "port": $ACTIVE_PORT,
            "last_active_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Set permissions
          sudo chmod 644 "$STATE_DIR/$INACTIVE_ENV.json"
          sudo chmod 644 "$STATE_DIR/$ACTIVE_ENV.json"

          echo "‚úÖ Deployment state updated - $INACTIVE_ENV is now active"

      # T057: Create GitHub deployment status (success)
      - name: Create GitHub deployment status
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"

          echo "Creating GitHub deployment status..."

          # Use GitHub API to create deployment status
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/deployments \
            -d "{
              \"ref\": \"${{ github.sha }}\",
              \"environment\": \"production-$INACTIVE_ENV\",
              \"description\": \"Deployed to $INACTIVE_ENV and traffic switched\",
              \"auto_merge\": false,
              \"required_contexts\": []
            }" || echo "Note: Deployment status creation failed (non-critical)"

  # T056-T057: Rollback job on test failure with GitHub deployment status
  rollback:
    name: Rollback on Failure
    runs-on: [self-hosted]
    timeout-minutes: 5
    needs: [detect-environment, deploy-inactive, post-deployment-tests]
    if: failure()  # Only run if post-deployment-tests failed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stop failed deployment
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"

          echo "Post-deployment tests failed. Rolling back $INACTIVE_ENV environment..."

          # Stop the failed deployment
          npx pm2 stop "weatherman-$INACTIVE_ENV" || echo "Process already stopped"
          npx pm2 delete "weatherman-$INACTIVE_ENV" || echo "Process already deleted"

          echo "‚úÖ Stopped failed $INACTIVE_ENV environment"

      - name: Update deployment state to failed
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"
          INACTIVE_PORT="${{ needs.detect-environment.outputs.inactive_port }}"
          STATE_DIR="${{ env.DEPLOYMENT_STATE_DIR }}"

          # Mark failed environment state
          cat <<EOF | sudo tee "$STATE_DIR/$INACTIVE_ENV.json" > /dev/null
          {
            "environment": "$INACTIVE_ENV",
            "status": "failed",
            "traffic_routing": "inactive",
            "port": $INACTIVE_PORT,
            "commit_sha": "${{ github.sha }}",
            "deployment_attempted_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}",
            "failure_reason": "Post-deployment tests failed"
          }
          EOF

          sudo chmod 644 "$STATE_DIR/$INACTIVE_ENV.json"

          echo "‚úÖ Updated state for failed $INACTIVE_ENV deployment"

      # T057: Create GitHub deployment status (failure)
      - name: Create GitHub deployment failure status
        run: |
          INACTIVE_ENV="${{ needs.detect-environment.outputs.inactive_env }}"

          echo "Creating GitHub deployment failure status..."

          # Use GitHub API to create deployment status
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/deployments \
            -d "{
              \"ref\": \"${{ github.sha }}\",
              \"environment\": \"production-$INACTIVE_ENV\",
              \"description\": \"Deployment to $INACTIVE_ENV failed - rolled back\",
              \"auto_merge\": false,
              \"required_contexts\": []
            }" || echo "Note: Deployment status creation failed (non-critical)"

          echo ""
          echo "üî¥ Rollback complete. Active environment remains unchanged."

  # Summary job
  deployment-summary:
    name: Deployment Summary
    runs-on: [self-hosted]
    needs: [detect-environment, deploy-inactive, post-deployment-tests, switch-traffic, rollback]
    if: always()
    steps:
      - name: Report deployment status
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Active environment: ${{ needs.detect-environment.outputs.active_env }}"
          echo "Deployed to: ${{ needs.detect-environment.outputs.inactive_env }}"
          echo "Deploy status: ${{ needs.deploy-inactive.result }}"
          echo "Tests status: ${{ needs.post-deployment-tests.result }}"
          echo "Switch status: ${{ needs.switch-traffic.result }}"
          echo "Rollback status: ${{ needs.rollback.result }}"
          echo ""

          if [[ "${{ needs.deploy-inactive.result }}" == "success" ]] && \
             [[ "${{ needs.post-deployment-tests.result }}" == "success" ]] && \
             [[ "${{ needs.switch-traffic.result }}" == "success" ]]; then
            echo "‚úÖ Deployment completed successfully"
            echo "Traffic is now routed to: ${{ needs.detect-environment.outputs.inactive_env }}"
            exit 0
          elif [[ "${{ needs.rollback.result }}" == "success" ]]; then
            echo "‚ö†Ô∏è  Deployment failed but rollback completed successfully"
            echo "Traffic remains on: ${{ needs.detect-environment.outputs.active_env }}"
            exit 1
          else
            echo "‚ùå Deployment encountered issues"
            exit 1
          fi
