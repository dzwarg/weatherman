# Sudoers configuration for Weatherman deployment automation
#
# Installation:
#   sudo visudo -c -f /Users/mm39178/repos/weatherman/scripts/deployment/weatherman-sudoers
#   sudo cp /Users/mm39178/repos/weatherman/scripts/deployment/weatherman-sudoers /etc/sudoers.d/weatherman
#   sudo chmod 440 /etc/sudoers.d/weatherman
#
# This file grants the 'weatherman' user/role minimum privileges needed
# for blue-green deployment automation scripts.
#
# Security: NOPASSWD is used for automation; ensure the weatherman user
# has restricted access and is only used by GitHub Actions runner.

# User/Group that will execute deployment scripts
# Replace 'weatherman' with actual username or use %group for groups
User_Alias DEPLOY_USERS = weatherman

# Basic test commands (for deployment prerequisite checks)
Cmnd_Alias TEST_CMDS = \
    /bin/true, \
    /usr/bin/true

# Nginx configuration management
Cmnd_Alias NGINX_CONFIG = \
    /bin/mkdir -p /var/lib/weatherman/backups, \
    /usr/bin/mkdir -p /var/lib/weatherman/backups, \
    /bin/cp /etc/nginx/sites-enabled/weatherman /var/lib/weatherman/backups/nginx-weatherman.backup.*, \
    /usr/bin/cp /etc/nginx/sites-enabled/weatherman /var/lib/weatherman/backups/nginx-weatherman.backup.*, \
    /bin/cp /var/lib/weatherman/backups/nginx-weatherman.backup.* /etc/nginx/sites-enabled/weatherman, \
    /usr/bin/cp /var/lib/weatherman/backups/nginx-weatherman.backup.* /etc/nginx/sites-enabled/weatherman, \
    /bin/sed -i s* /etc/nginx/sites-enabled/weatherman, \
    /usr/sbin/nginx -t, \
    /bin/systemctl reload nginx, \
    /usr/bin/systemctl reload nginx

# Deployment state directory management
Cmnd_Alias STATE_MGMT = \
    /bin/mkdir -p /var/lib/weatherman/state/, \
    /bin/mkdir -p /var/lib/weatherman/state, \
    /bin/chmod 755 /var/lib/weatherman/state/, \
    /bin/chmod 755 /var/lib/weatherman/state, \
    /bin/chmod 644 /var/lib/weatherman/state/*.json, \
    /usr/bin/tee /var/lib/weatherman/state/blue.json, \
    /usr/bin/tee /var/lib/weatherman/state/green.json

# Frontend deployment directory management (explicit paths only - no wildcards)
Cmnd_Alias FRONTEND_DEPLOY = \
    /bin/mkdir -p /var/www/weatherman/blue, \
    /bin/mkdir -p /var/www/weatherman/green, \
    /usr/bin/mkdir -p /var/www/weatherman/blue, \
    /usr/bin/mkdir -p /var/www/weatherman/green, \
    /bin/rm -rf /var/www/weatherman/blue, \
    /bin/rm -rf /var/www/weatherman/green, \
    /usr/bin/rm -rf /var/www/weatherman/blue, \
    /usr/bin/rm -rf /var/www/weatherman/green, \
    /bin/cp -r packages/frontend/dist/. /var/www/weatherman/blue/, \
    /bin/cp -r packages/frontend/dist/. /var/www/weatherman/green/, \
    /usr/bin/cp -r packages/frontend/dist/. /var/www/weatherman/blue/, \
    /usr/bin/cp -r packages/frontend/dist/. /var/www/weatherman/green/, \
    /usr/bin/chown -R www-data\:www-data /var/www/weatherman/blue, \
    /usr/bin/chown -R www-data\:www-data /var/www/weatherman/green, \
    /bin/chown -R www-data\:www-data /var/www/weatherman/blue, \
    /bin/chown -R www-data\:www-data /var/www/weatherman/green, \
    /bin/chmod -R 755 /var/www/weatherman/blue, \
    /bin/chmod -R 755 /var/www/weatherman/green, \
    /usr/bin/chmod -R 755 /var/www/weatherman/blue, \
    /usr/bin/chmod -R 755 /var/www/weatherman/green

# Backend deployment directory management (explicit paths only - no wildcards)
Cmnd_Alias BACKEND_DEPLOY = \
    /bin/mkdir -p /opt/weatherman/blue, \
    /bin/mkdir -p /opt/weatherman/green, \
    /usr/bin/mkdir -p /opt/weatherman/blue, \
    /usr/bin/mkdir -p /opt/weatherman/green, \
    /bin/rm -rf /opt/weatherman/blue, \
    /bin/rm -rf /opt/weatherman/green, \
    /usr/bin/rm -rf /opt/weatherman/blue, \
    /usr/bin/rm -rf /opt/weatherman/green, \
    /bin/cp -r packages/server/. /opt/weatherman/blue/, \
    /bin/cp -r packages/server/. /opt/weatherman/green/, \
    /usr/bin/cp -r packages/server/. /opt/weatherman/blue/, \
    /usr/bin/cp -r packages/server/. /opt/weatherman/green/, \
    /bin/cp pm2.blue.config.cjs /opt/weatherman/blue/, \
    /bin/cp pm2.green.config.cjs /opt/weatherman/green/, \
    /usr/bin/cp pm2.blue.config.cjs /opt/weatherman/blue/, \
    /usr/bin/cp pm2.green.config.cjs /opt/weatherman/green/, \
    /bin/cp package-lock.json /opt/weatherman/blue/, \
    /bin/cp package-lock.json /opt/weatherman/green/, \
    /usr/bin/cp package-lock.json /opt/weatherman/blue/, \
    /usr/bin/cp package-lock.json /opt/weatherman/green/, \
    /bin/cp -r node_modules /opt/weatherman/blue/, \
    /bin/cp -r node_modules /opt/weatherman/green/, \
    /usr/bin/cp -r node_modules /opt/weatherman/blue/, \
    /usr/bin/cp -r node_modules /opt/weatherman/green/, \
    /bin/chown -R weatherman\:weatherman /opt/weatherman/blue, \
    /bin/chown -R weatherman\:weatherman /opt/weatherman/green, \
    /usr/bin/chown -R weatherman\:weatherman /opt/weatherman/blue, \
    /usr/bin/chown -R weatherman\:weatherman /opt/weatherman/green, \
    /bin/chown -R weatherman\:weatherman /opt/weatherman/blue/node_modules, \
    /bin/chown -R weatherman\:weatherman /opt/weatherman/green/node_modules, \
    /usr/bin/chown -R weatherman\:weatherman /opt/weatherman/blue/node_modules, \
    /usr/bin/chown -R weatherman\:weatherman /opt/weatherman/green/node_modules, \
    /bin/chmod -R 755 /opt/weatherman/blue, \
    /bin/chmod -R 755 /opt/weatherman/green, \
    /usr/bin/chmod -R 755 /opt/weatherman/blue, \
    /usr/bin/chmod -R 755 /opt/weatherman/green

# Allow deployment users to execute these commands without password
DEPLOY_USERS ALL=(root) NOPASSWD: TEST_CMDS, NGINX_CONFIG, STATE_MGMT, FRONTEND_DEPLOY, BACKEND_DEPLOY

# Optional: Add logging for audit trail
Defaults:DEPLOY_USERS log_output
